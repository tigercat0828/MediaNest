<div class="card border-1 shadow-sm" style="width: @WidthRem;">
    <a class="position-relative" href="@Link">
        <img src="@Source" class="card-img-top" alt="@Title" style="height: @HeightPx; object-fit: cover;"
             onerror="fallbackImage(this)" />
    </a>
    <div class="card-body p-2">
        <h6 class="card-title mb-1 text-truncate">@Title</h6>
    </div>

    @if (ShowAddButton) {
        <button class="btn btn-sm position-absolute top-0 end-0 m-1 rounded-circle btn-primary"
                @onclick:stopPropagation="true"
                @onclick="OnAddClicked">
            <i class="bi bi-plus" )"></i>
        </button>
    }

</div>

@* ✅ 新增：右上角浮動按鈕（只在 ShowAddButton 為 true 時出現） *@

@code {
    [Parameter] public string? Title { get; set; }
    [Parameter] public string? Link { get; set; }
    [Parameter] public string? Source { get; set; }

    [Parameter] public string? WidthRem { get; set; } = "16rem";
    [Parameter] public string? HeightPx { get; set; } = "300px";

    [Parameter] public EventCallback OnAddClicked { get; set; }
    // ✅ 新增參數
    [Parameter] public bool ShowAddButton { get; set; } = false;
}

<style>
    .btn-primary:hover, .btn-success:hover {
        filter: brightness(1.1);
    }
</style>

<script>
    function fallbackImage(img) {
        // 支援的副檔名 (依序嘗試)
        const fallbackExts = ["jpg", "webp", "jpeg", "png"];

        // 若尚未初始化索引，設為 0
        if (!img.dataset.fallbackIndex) {
            img.dataset.fallbackIndex = 0;
        }

        let idx = parseInt(img.dataset.fallbackIndex, 10);

        // 取得原始路徑與主檔名（不含副檔名）
        const originalSrc = img.dataset.originalSrc || img.src;
        const baseName = originalSrc.substring(0, originalSrc.lastIndexOf('.'));

        // 初始化時存下原始檔路徑
        if (!img.dataset.originalSrc) {
            img.dataset.originalSrc = originalSrc;
        }

        // 嘗試下個副檔名
        if (idx < fallbackExts.length) {
            const newSrc = `${baseName}.${fallbackExts[idx]}`;
            img.src = newSrc;
            img.dataset.fallbackIndex = idx + 1;
        } else {
            // 全部失敗時，設為預設圖
            img.src = "/images/placeholder.jpg";
        }
    }
</script>
