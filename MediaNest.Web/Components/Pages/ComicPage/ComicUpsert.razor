@page "/comic/create"
@page "/comic/edit/{id}"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin,User")]

@using MediaNest.Shared
@using MediaNest.Shared.Entities
@using MediaNest.Shared.Services
@using MediaNest.Shared.Services.Background

<AuthorizeView Roles="Admin,User">
    <NotAuthorized>
        <div class="alert alert-info mt-2">
            Please <a href="/account/login">Login</a> first!
        </div>
    </NotAuthorized>

    <Authorized Context="auth">
        <div class="container">
            <div class="row">
                <div class="card card-body mb-3">
                    <EditForm Model="_currentComic" FormName="ComicForm">
                        <DataAnnotationsValidator />
                        @if (_isEditMode) {
                            <h3>Edit Comic</h3>
                        }
                        else {
                            <h3>New Comic</h3>
                        }
                        <div class="mb-3">
                            <label>Title</label>
                            <InputText class="form-control" @bind-Value="_currentComic.Title" />
                        </div>

                        <button type="button" class="btn btn-outline-secondary mb-3" @onclick="ToggleMoreOptionPanel">
                            @(_showMoreOptionPanel ? "Hide Options" : "More Options")
                        </button>

                        @if (_showMoreOptionPanel) {
                            <div class="mb-3">
                                <label>SubTitle</label>
                                <InputText class="form-control" @bind-Value="_currentComic.SubTitle" />
                            </div>

                            <div class="row mb-3">
                                <div class="col-6">
                                    <label>Author</label>
                                    <InputText class="form-control" @bind-Value="_currentComic.Author" />
                                </div>
                                <div class="col-6">
                                    <label>Tags</label>
                                    <TagInput @bind-Tags="_currentComic.Tags" />
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-6">
                                    <label>Series</label>
                                    <InputText class="form-control" @bind-Value="_currentComic.Series" />
                                </div>
                                <div class="col-6">
                                    <label>Figures</label>
                                    <TagInput @bind-Tags="_currentComic.Characters" />

                                </div>
                            </div>

                            <div class="mb-3">
                                <label>Bookmarks</label>
                                <TagInput @bind-Tags="_bookmarkStrs" />
                            </div>
                        }

                        @if (!_isEditMode) {
                            <div class="mb-3">
                                <ComicFileUpload SaveDirectory="@_directory" SaveSubFolder="@_currentComic.Folder" OnUploadButtonPressed="HandleUploadButtonPressed" />
                            </div>
                        }
                        <div>
                            @if (_isUploadButtonPressed || _isEditMode) {
                                <button type="button" class="btn btn-success" @onclick="HandleUpsertGame">完成</button>
                            }
                        </div>
                    </EditForm>
                </div>
            </div>
            <div>
                <div class="col mb-2">
                    
                    @if (_selectedImages.Count > 0) {
                        <button class="btn btn-outline-primary mb-2 me-2" @onclick="AddToBookMark">加入書籤</button>
                        <button class="btn btn-outline-danger mb-2 me-2" @onclick="() => { _showConfirmDelete = !_showConfirmDelete; }">
                            刪除選中 (@_selectedImages.Count)
                        </button>
                        @if (_showConfirmDelete){
                            <button class="btn btn-danger mb-2 me-2" @onclick="DeleteSelectedImages">
                                Confirm (@_selectedImages.Count)
                            </button>
                        }
                        
                    }
                    @if (_currentComic.Bookmarks.Count > 1) {
                        <button class="btn btn-outline-danger mb-2 me-2" @onclick="() => { _showConfirmSplit = !_showConfirmSplit; }">拆分</button>
                        @if (_showConfirmSplit) {
                            <button class="btn btn-danger mb-2 me-2" @onclick="SplitComic">Confirm</button>
                        }
                    }
                </div>
            </div>
            <div class="d-flex flex-wrap">
                @for (int i = 0; i < _imageSrcs.Count; i++) {
                    var imgFile = _imageSrcs[i];
                    bool isSelected = _selectedImages.Contains(imgFile);

                    <div class="p-1">
                        <img src="/Assets/Comics/Thumbs/@_currentComic.Folder/@imgFile?v=@DateTime.Now.Ticks"
                                alt="Page @i"
                                class="comic-img @(isSelected ? "selected" : "")"
                                @onclick="() => ToggleSelect(imgFile)" /> 
                    </div>
                }
            </div>
        </div>
    </Authorized>
</AuthorizeView>

@code {
    // TODO : uploader with authentication
    [CascadingParameter] private Task<AuthenticationState> _authStateTask { get; set; }
    [Parameter] public string id { get; set; }

    @inject NavigationManager Navigation
    @inject FileService FileService 
    @inject ComicService ComicService
    @inject IBackgroundTaskQueue TaskQueue 

    private string _directory => FileService.ComicFolder;
    private bool _isEditMode = false;
    private Comic _currentComic = new();

    private List<string> _bookmarkStrs = [];
    private string _oldTitle = "";
    private bool _isUploadButtonPressed = false;
    private bool _showMoreOptionPanel = false;

    // 選中頁面功能
    private HashSet<string> _selectedImages = [];
    private List<string> _imageSrcs = [];
    private bool _showConfirmDelete = false;
    private bool _showConfirmSplit = false;
    private bool _isSplitting = false;

    protected override async Task OnInitializedAsync() {

        var authState = await _authStateTask;
        if (authState.User.Identity?.IsAuthenticated ?? false) {
            if (id != null) {
                _isEditMode = true;
                _showMoreOptionPanel = true;
                _currentComic = await ComicService.GetComicById(id);
                _bookmarkStrs = _currentComic.Bookmarks.Select(x => x.ToString()).ToList();
                _oldTitle = _currentComic.Title;
                LoadImageSrcs();
            }
        }
    }

    private async Task HandleUpsertGame() {
                

        _currentComic.Uploader = ""; 
        if (_isEditMode) {
            await ComicService.UpdateComic(id, _currentComic, _oldTitle);
        }
        else {
            await TaskQueue.EnqueueTask(async token => {
                await ComicService.CreateComic(_currentComic);
            });
        }
        Navigation.NavigateTo($"/comic/{_currentComic.Id}");
    }
    private async Task SplitComic(){
        if (_isSplitting) return;
        _showConfirmSplit = false;
        Navigation.NavigateTo($"/comic/{_currentComic.Id}");
        _isSplitting = true;
        await ComicService.SplitComic(_currentComic);
        _isSplitting = false;
    }

    private void HandleUploadButtonPressed(bool isPressed) {
        // 當按鈕被按下時更新狀態
        _isUploadButtonPressed = isPressed;
    }
    private void ToggleMoreOptionPanel() {
        _showMoreOptionPanel = !_showMoreOptionPanel;
    }

    void LoadImageSrcs() {
        var folderName = Path.Combine(FileService.ComicFolder, "Thumbs", _currentComic.Folder);
        foreach (var path in Directory.GetFiles(folderName)) {
            _imageSrcs.Add(Path.GetFileName(path));
        }
    }

    private void ToggleSelect(string imgFile) {
        if (_selectedImages.Contains(imgFile))
            _selectedImages.Remove(imgFile);
        else
            _selectedImages.Add(imgFile);
    }
    private void DeleteSelectedImages() {
        var comicFolder = Path.Combine(FileService.AssetsFolder, "Comics", _currentComic.Folder);
        var thumbFolder = Path.Combine(FileService.AssetsFolder, "Comics", "Thumbs", _currentComic.Folder);

        // 刪除選中的原圖與縮圖
        foreach (var imgFile in _selectedImages.ToList()) {
            string source = Path.Combine(comicFolder, imgFile);
            string thumb = Path.Combine(thumbFolder,imgFile);
            FileService.DeleteFile(source);
            FileService.DeleteFile(thumb);
            _imageSrcs.Remove(imgFile);
        }
        _selectedImages.Clear();

        // --- 重新命名剩下的圖片與縮圖 ---
        var ordered = _imageSrcs.OrderBy(x => x).ToList();
        _imageSrcs.Clear();

        int counter = 1;
        foreach (var oldName in ordered) {
            string ext = Path.GetExtension(oldName);
            string newName = $"{counter:D3}{ext}";

            string oldPath = Path.Combine(comicFolder, oldName);
            string newPath = Path.Combine(comicFolder, newName);
            string oldThumb = Path.Combine(thumbFolder, oldName);
            string newThumb = Path.Combine(thumbFolder, newName);

            // 原圖重命名
            if (!oldName.Equals(newName, StringComparison.OrdinalIgnoreCase)) {
                File.Move(oldPath, newPath, true);
            }

            // 縮圖重命名（若存在）
            if (!oldName.Equals(newName, StringComparison.OrdinalIgnoreCase)) {
                File.Move(oldThumb, newThumb);
            }
            _imageSrcs.Add(newName);
            counter++;
        }
        StateHasChanged();
    }
    private void AddToBookMark() {
        foreach (var imgFile in _selectedImages) {
            // 取頁碼 (001.jpg → 1)
            string fileName = Path.GetFileNameWithoutExtension(imgFile);
            if (int.TryParse(fileName, out int pageNum)) {
                if (!_currentComic.Bookmarks.Contains(pageNum)) {
                    _currentComic.Bookmarks.Add(pageNum);
                }
            }
        }

        // 排序，確保 bookmark 順序正確
        _currentComic.Bookmarks = _currentComic.Bookmarks.Distinct().OrderBy(x => x).ToList();
        _bookmarkStrs = _currentComic.Bookmarks.Select(x => x.ToString()).ToList();
        // 更新文字框同步
        _currentComic.Bookmarks = _bookmarkStrs.Select(int.Parse).ToList();
        // 清空選中狀態
        _selectedImages.Clear();
        StateHasChanged();
    }

}

<style>
.comic-img {
    width: 9rem;
    cursor: pointer;
    border: 3px solid transparent;
    transition: border 0.2s;
}

.comic-img.selected {
    border: 3px solid red;
}
</style>