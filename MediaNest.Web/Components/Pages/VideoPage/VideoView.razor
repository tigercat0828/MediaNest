@page "/video/{id}"
@attribute [Authorize(Roles="Admin,User")]
@rendermode InteractiveServer

@if(_video != null) {
	<PageTitle>@_video.Title</PageTitle>


	<div class="container">
		<div class="row mt-3">
			<div class="col-8">
				<nav aria-label="breadcrumb">
					<ol class="breadcrumb">
						<li class="breadcrumb-item"><a href="/">Home</a></li>
						<li class="breadcrumb-item"><a href="/video">Video</a></li>
						<li class="breadcrumb-item active" aria-current="page">@_video.Code</li>
					</ol>
				</nav>
			</div>
			<div class="col-4 d-flex justify-content-end">
				<button class="btn btn-danger me-1"><i class="bi bi-trash" @onclick="ToggleShowDeleteBtn"></i></button>
				@if (_showDeleteConfirm) {
					<button class="btn btn-outline-danger" @onclick="DeleteVideo"><i class="bi bi-check"></i></button>
				}
			</div>

			<div class="row">
				<h3>@_video.Title</h3>
			</div>

			<div class="row mb-4">
				<div class="col-12">
					<span class="badge bg-secondary">@_video.Code</span>
					<a href="/video/search/@_video.Author" class="badge bg-warning me-1">@_video.Author</a>
					@foreach (var tag in _video.Tags) {
						<a href="/comic/search/@tag" class="badge bg-secondary me-1">@tag</a>
					}
				</div>
			</div>


		</div>


		<video controls width="640" height="360" poster="cover.jpg">
			@{
				string src = $"/Assets/Videos/{_video.Folder}/{_video.Title}.mp4";
			}
			<source src="@src" type="video/mp4">

		@* 	<!-- English subtitles -->
			<track src="subtitles-en.vtt" kind="subtitles" srclang="en" label="English" default>

			<!-- Traditional Chinese subtitles -->
			<track src="subtitles-zh.vtt" kind="subtitles" srclang="zh" label="繁體中文">
			Your browser does not support the video tag. *@
		</video>
		<div class="row mb-3">
			<div class="col-1">
				<button class="btn btn-outline-primary mt-3" @onclick="ToggleEditPanel">
					@(_showEditPanel ? "Close" : "Edit")
				</button>
			</div>
		</div>
		<div class="row">
			@if (_showEditPanel && _video != null) {
				<div class="card card-body">
					<EditForm Model="_video">
						<div class="mb-3">
							<label>Title</label>
							<InputText class="form-control" @bind-Value="_video.Title" />
						</div>
						<div class="mb-3">
							<label>Author</label>
							<InputText class="form-control" @bind-Value="_video.Author" />
						</div>
						<div class="mb-3">
							<label>Tags</label>
							<InputText class="form-control" @bind-Value="_tagStr" />
						</div>
						<button class="btn btn-success" @onclick="UpdateVideo">Save</button>
					</EditForm>
				</div>
			}
		</div>
		
	</div>
}
else {
	<LoadingSpinner />
}


@code {
	[Parameter] public string? id { get; set; }
	@inject VideoService VideoService
	@inject NavigationManager NavigationManager
	private Video? _video;

	private bool _showDeleteConfirm = false;
	
	private bool _showEditPanel = false;
	private string? _oldTitle;
	private string? _tagStr;

	protected override async Task OnInitializedAsync() {
		_video = await VideoService.GetById(id);
		_tagStr = string.Join(", ", _video.Tags);
		_oldTitle = _video.Title;
	}
	private async Task DeleteVideo() {
		await VideoService.DeleteVideo(id);
		NavigationManager.NavigateTo("/video");
	}
	private void ToggleShowDeleteBtn() {
		_showDeleteConfirm = !_showDeleteConfirm;
	}

	private void ToggleEditPanel() {
		_showEditPanel = !_showEditPanel;
	}
	private async Task UpdateVideo() {
		_video.Tags = _tagStr.Split(',', StringSplitOptions.RemoveEmptyEntries).ToList();
		await VideoService.UpdateVideo(id, _video, _oldTitle);
		_showEditPanel = false;
	}
}
