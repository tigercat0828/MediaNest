@page "/rapid-upload"
@using MediaNest.Shared.Entities
@using MediaNest.Shared.Models
@using System.Threading.Tasks
@using MediaNest.Shared.Services.Background

@rendermode InteractiveServer

@if (_showOk) {
	<button class="btn btn-success mb-3" @onclick="Okay">Okay</button>
}

<div class="container">
	<div class="card card-body mb-3">
		<h4 class="card-title">上傳漫畫</h4>
		<FileUpload SaveDirectory="@_taskFolder" OnUploadButtonPressed="HandleUploadComicBtnPressed" />
		@if (_showImport) {
			<button class="btn btn-outline-primary" @onclick="ImportComic">匯入</button>
		}
	</div>
	
	
	<div class="card card-body mb-3">
		<h4 class="card-title">上傳影片</h4>
		<FileUpload SaveDirectory="" />
		<button class="btn btn-outline-primary" >匯入</button>
	</div>
	<div class="card card-body mb-3">
		<h4 class="card-title">上傳音樂</h4>
		<FileUpload SaveDirectory="" />
		<button class="btn btn-outline-primary" >匯入</button>
	</div>

</div>


@code {
	//@inject ComicServiceLegacy ComicService
	@inject ComicService ComicService
	@inject FileService FileService
	@inject NavigationManager NavigationManager
	@inject IBackgroundTaskQueue TaskQueue

	private List<string> _uploadedFiles = [];
	List<string> _importedTitles = [];
	private string _taskFolder => FileService.TaskFolder;
	private bool _showOk = false;
	private bool _showImport = false;

	protected override void OnInitialized() {
	}
	
	private async Task ImportComic() {
		_showImport = false;
		_showOk = false;
		StateHasChanged();
		_uploadedFiles = Directory.GetFiles(_taskFolder, "*.zip").ToList();

		foreach (var file in _uploadedFiles) {
			await TaskQueue.EnqueueTask(async token => {
				try {
					var importer = new ComicZipImporter(FileService.ComicFolder);
					Comic comic = importer.ImportComic(file);
					await ComicService.CreateComic(comic, false);
					File.Delete(file);
				}
				catch (Exception ex) {
					Console.WriteLine($"❌ 匯入失敗: {file} - {ex.Message}");
				}
			});
		}
		_showOk = true;
	}
	private async Task ImportMusic() {
		
		
	}
	private void Okay() {
		NavigationManager.NavigateTo("/rapid-upload", true);
	}
	private void HandleUploadComicBtnPressed(bool args) {
		_showImport = true;
	}
}
